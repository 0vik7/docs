# Аутентификация с помощью SAML-федерации

Это общая инструкция о настройке аутентификации в облаке через SAML-совместимую федерацию. Используйте эту инструкцию, если для вашей SAML-федерации нет [специальной инструкции](../index.md#federations).

Чтобы настроить аутентификацию:

1. [Создайте федерацию в облаке](#create-federation).
1. [Добавьте сертификаты в федерацию](#add-certificate).
1. [Получите ссылку для входа в консоль](#get-link).
1. [Настройте аутентификацию на своем сервере](#configure-sso).
1. [Добавьте пользователей в облако](#add-users).
1. [Протестируйте аутентификацию](#test-auth).

## Перед началом {#before-begin}

Для того, чтобы воспользоваться инструкциями в этом разделе, вам понадобятся:

1. Роль [admin](../../concepts/access-control/roles.md#admin) или [resource-manager.clouds.owner](../../concepts/access-control/roles.md#owner) в облаке, для которого вы хотите настроить SAML-аутентификацию.
1. Действующий сертификат, который используется для подписи SAML-сообщений на сервере поставщика удостоверений (IdP). Если у вас нет действующего SSL-сертификата, получите новый.

    Имя субъекта в сертификате должно содержать FQDN сервера поставщика удостоверений, например `fs.contoso.com`, чтобы страница аутентификации не могла быть заблокирована браузером.


## Создайте федерацию в облаке {#create-federation}

{% list tabs %}

- Консоль управления

  Чтобы создать федерацию в {{ iam-short-name }}:

  1. Откройте страницу каталога в [консоли управления]({{ link-console-main }}).
  1. В меню слева выберите вкладку **Федерации**.
  1. Нажмите **Создать федерацию**.
  1. Задайте имя федерации. Имя должно быть уникальным в каталоге.
  1. При необходимости добавьте описание.
  1. В поле **Время жизни cookie** укажите время, в течении которого браузер не должен требовать у пользователя повторной аутентификации.
  1. В поле **IdP Issuer** укажите идентификатор IdP-сервера, на котором должна происходить аутентификация. Этот же идентификатор сервер IdP указывает в ответе сервису {{ iam-short-name }} после того, как пользователь проходит аутентификацию.
  1. В поле **Ссылка на страницу для входа в IdP** укажите адрес страницы, на которую браузер должен перенаправить пользователя для аутентификации.
  1. Вы можете включить опцию **Автоматически создавать пользователей**, чтобы аутентифицированный пользователь автоматически добавлялся в облако. Эта опция упрощает процесс заведения пользователей, но созданному таким образом пользователю по умолчанию назначается только роль `resource-manager.clouds.member`: он не сможет выполнять никаких операций с ресурсами в этом облаке. Исключение — те ресурсы, на которые назначены роли системной группе `allUsers` или `allAuthenticatedUsers`.
    
     Если эту опцию не включать, то пользователь, которого не добавили в облако, не сможет войти в консоль управления, даже если пройдет аутентификацию на вашем сервере. В этом случае вы можете управлять белым списком пользователей, которым разрешено пользоваться Яндекс.Облаком.
{% endlist %}

## Укажите сертификаты для федерации {#add-certificate}

{% include [federation-sertificates-note](../../../_includes/iam/federation-sertificates-note.md) %}

{% include [federation-sertificates-add](../../../_includes/iam/federation-sertificates-add.md) %}

## Получите ссылку для входа в консоль {#get-link}

{% include [federation-login-link](../../../_includes/iam/federation-login-link.md) %}

## Настройте аутентификацию на своем сервере {#configure-sso}

После того, как вы создали федерацию и получили получили ссылку для входа в консоль управления, настройте сервер поставщика удостоверений. После каждого успешного прохождения аутентификации сервер должен отправлять консоли управления соответствующее SAML-сообщение.

В SAML-сообщении должен быть указан уникальный идентификатор пользователя (`Name ID`) и ссылка для входа в консоль управления.

## Добавьте пользователей в облако {#add-users}

{% include [add-federated-users](../../../_includes/iam/add-federated-users.md) %}

## Протестируйте аутентификацию {#test-auth}

Теперь, когда вы закончили настройку сервера, проверьте аутентификацию:

1. Откройте браузер в гостевом режиме или режиме инкогнито для чистой симуляции нового пользователя.
1. Перейдите по [ссылке для входа в консоль управления](#get-link), которую вы получили ранее. Браузер должен перенаправить вас на страницу аутентификации.
1. Ведите ваши аутентификационные данные. По умолчанию необходимо ввести UPN и пароль. Затем нажмите кнопку **Sign in**.
1. После успешной аутентификации сервер перенаправит вас обратно по ссылке для входа в консоль, а после этого — на главную страницу консоли управления. В правом верхнем углу вы сможете увидеть, что вошли в консоль от имени федеративного пользователя.

#### Что дальше

* [Назначьте роли добавленным пользователям](../roles/grant.md#access-to-federated-user).
