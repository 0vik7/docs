# Импорт данных в Managed Service for PostgreSQL

Чтобы перенести существующую базу данных PostgreSQL в сервис [!KEYREF mpg-name], используйте утилиты `pg_dump` и `pg_restore`: создайте дамп рабочей базы и восстановите его в [!KEYREF PG]-кластере Облака.

Перед тем, как пытаться импортировать данные, проверьте, совпадают ли версии СУБД у существующей базы данных и вашего кластера в Облаке. Если версии разные, восстановить сделанный дамп не получится.

Сложность и длительность миграции сильно зависит от размера базы. Миграция базы данных размером в несколько гигабайт может оказаться гораздо сложнее, чем миграция базы в несколько мегабайт и с небольшим количеством таблиц.

Этапы миграции:
1. Создание дампа переносимой базы.
2. Создание виртуальной машины в Яндекс Облаке и загрузка данных на неё (опционально).
3. Создание Managed PostgreSQL кластера.
4. Восстановление данных из дампа в кластере с использованием `pg_restore`.


## Создание дампа {#dump}

Создать дамп базы данных следует с помощью утилиты [pg_dump](https://www.postgresql.org/docs/current/app-pgdump.html).

1. Перед созданием дампа рекомендуется переключить базу в режим «только чтение», чтобы не потерять данные, которые бы появились во время создания дампа. Сам дамп базы данных создается следующей командой:

    ```
    $ pg_dump -h <адрес сервера СУБД> -U <имя пользователя> -Fd -d <имя базы данных> -f ~/db_dump
    ```

2. Для ускорения процесса вы можете запустить сброс дампа, используя несколько ядер процессора. Для этого задайте флаг `-j` с числом, соответствующим количеству ядер, которое доступно СУБД:

    ```
    $ pg_dump -h <адрес сервера СУБД> -U <имя пользователя> -j 4 -Fd -d <имя базы данных> ~/db_dump
    ```

3. Упакуйте дамп в архив:

    ```
    $ tar -cvzf db_dump.tar.gz ~/db_dump
    ```

Подробно утилита `pg_dump` описана в [документации [!KEYREF PG]](https://www.postgresql.org/docs/current/app-pgdump.html).


## (опционально) Создание виртуальной машины в Облаке и загрузка дампа {#create-vm}

Переносить данные на промежуточную виртуальную машину в [!KEYREF compute-name] нужно, если:

* К вашему кластеру БД  нет доступа из интернета.
* Ваше оборудование или соединение с PostgreSQL-кластером в Облаке недостаточно надежны.

Нужное количество оперативной памяти и ядер процессора зависит от объема переносимых данных и требуемой скорости переноса.

1. В консоли управления создайте новую виртуальную машину из образа Ubuntu 18.04. Параметры виртуальной машины должны зависеть от размера базы, которую Вы хотите перенести. Минимальной конфигурации (1 ядро, 2 ГБ RAM, 10 ГБ дискового пространства) должно хватить для переносы базы до 1 ГБ. Чем больше переносимая база, тем больше должно быть дискового пространства (как минимум в два раза больше, чем размер базы), и больше размер оперативной памяти.

    Виртуальная машина должна находиться в той же сети и зоне доступности, что хост-мастер кластера [!KEYREF PG]. Кроме того, виртуальной машине должен быть присвоен внешний IP-адрес, чтобы вы могли загрузить дамп извне Облака.

2. Установите клиент [!KEYREF PG] и дополнительные утилиты для работы с СУБД:

    ```
    $ sudo apt install postgresql-client-common
    
    $ sudo apt install postgresql-client-10 # Для PostgreSQL 10
    
    $ sudo apt install postgresql-client-11 # Для PostgreSQL 11
    ```

3. Перенесите дамп базы данных на виртуальную машину, например, используя утилиту `scp`:

    ```
    scp ~/db_dump.tar.gz <имя пользователя ВМ>@<публичный адрес ВМ>:/tmp/db_dump.tar.gz
    ```
4. Распакуйте дамп:

    ```
    tar -xzf /tmp/db_dump.tar.gz
    ```


## Восстановление данных {#restore}

Восстанавливать дамп базы данных следует с помощью утилиты [pg_restore](https://www.postgresql.org/docs/current/app-pgrestore.html).

Версия `pg_restore` должна совпадать с версией `pg_dump`, а мажорная версия должна быть не меньше, чем у базы на которую дамп разворачивается. То есть `pg_restore 10` следует использовать с PostgreSQL 10, а если необходимо развернуть дамп для PostgreSQL 11, то лучше воспользоваться `pg_restore 11`.

Восстановление лучше всего проводить с флагом `--single-transaction`, чтобы избежать неопределенного состояния базы в случае ошибки:

```
pg_restore -Fd \
           -v \
           -h <pgsql_host_address> \
           -U <username>
           -d <database_name> \
           -p 6432 \
           /tmp/db_dump \
           --single-transaction \
           --no-acl
```

Если нужно восстановить только одну схему, добавьте флаг `-n <имя схемы>`.

Подробно утилита `pg_restore` описана в [документации [!KEYREF PG]](https://www.postgresql.org/docs/current/app-pgrestore.html).
