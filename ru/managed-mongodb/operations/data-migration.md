# Миграция данных в [!KEYREF mmg-name]

Чтобы перенести существующую базу данных MongoDB в сервис [!KEYREF mmg-name], используйте утилиты `mongodump` и `mongorestore`: создайте дамп рабочей базы и восстановите его в [!KEYREF MG]-кластере Облака.

Перед тем, как пытаться импортировать данные, проверьте, совпадают ли версии СУБД у существующей базы данных и вашего кластера в Облаке. Если версии разные, восстановить сделанный дамп не получится.

Сложность и длительность миграции сильно зависит от размера базы. Миграция базы данных размером в десятки гигабайт может оказаться гораздо сложнее, чем миграция относительно небольшой базы в 1 гигабайт и с небольшим количеством таблиц.

Последовательность действий: 
1. Создать дамп переносимой базы с помощью утилиты `mongodump`.
2. Создать виртуальную машину в [!KEYREF compute-name], чтобы восстанавливать базу из дампа в инфраструктуре Яндекс.Облака (опционально).
3. Создать кластер [!KEYREF mmg-name], на котором будет развернута восстановленная база.
4. Восстановить данных из дампа в кластере с помощью утилиты `mongorestore`.


### Создание дампа {#dump}

Создать дамп базы данных следует с помощью утилиты `mongodump`. Подробно утилита описана в [документации [!KEYREF MG]](https://docs.mongodb.com/manual/reference/program/mongodump/).

1. Установите `mongodump` и дополнительные утилиты для работы с MongoDB. Пример для дистрибутивов Ubuntu и Debian:

    ```
    $ sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 9DA31620334BD75D9DCB49F368818C72E52529D4 
    ...
    $ echo "deb [ arch=amd64 ] https://repo.mongodb.org/apt/ubuntu bionic/mongodb-org/4.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-4.0.list 
    ...
    $ sudo apt-get update
    ...
    $ sudo apt-get install mongodb-org-shell mongodb-org-tools 
    ```

Инструкции для других платформ, а также более подробную информацию об установке утилит можно найти на странице [Install MongoDB](https://docs.mongodb.com/manual/installation/).

2. Перед созданием дампа рекомендуется переключить СУБД в режим «только чтение», чтобы не потерять данные, которые могут появиться за время создания дампа.

3. Создайте дамп базы данных:

    ```
    $ mongodump --host <адрес сервера СУБД> --port <порт> --username <имя пользователя> --password "<пароль>" --db <имя базы данных> --out ~/db_dump
    ```
   
   Если вы можете использовать несколько ядер процессора для создания дампа, задайте флаг `-j` с количеством доступных ядер:

    ```
    $ mongodump --host <адрес сервера СУБД> --port <порт> --username <имя пользователя> --password "<пароль>" -j <количество потоков> --db <имя базы данных> --out ~/db_dump
    ```

4. Архивируйте дамп:

    ```
    $ tar -cvzf db_dump.tar.gz ~/db_dump
    ```


### (опционально) Создать виртуальную машину для загрузки дампа {#create-vm}

Промежуточная виртуальная машина в [!KEYREF compute-full-name] понадобится, если:

* К вашему серверу СУБД нет доступа из интернета.
* Ваше оборудование или соединение с кластером [!KEYREF mmg-name] недостаточно надежны.

1. В консоли управления [создайте новую виртуальную машину](../../compute/operations/vm-create/create-linux-vm.md) из образа Ubuntu 18.04. Нужное количество оперативной памяти и ядер процессора зависит от объема переносимых данных и требуемой скорости переноса.

   Минимальной конфигурации (1 ядро, 2 ГБ RAM, 10 ГБ дискового пространства) должно хватить для переносы базы до 1 ГБ. Чем больше переносимая база, тем больше должно быть дискового пространства (как минимум в два раза больше, чем размер базы) и оперативной памяти.

   Виртуальная машина должна находиться в той же сети и зоне доступности, что хост-мастер кластера [!KEYREF mmg-name]. Кроме того, виртуальной машине должен быть присвоен внешний IP-адрес, чтобы вы могли загрузить файл дампа извне Облака.

2. Установите клиент [!KEYREF MG] и дополнительные утилиты для работы с СУБД:

    ```
    $ sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 9DA31620334BD75D9DCB49F368818C72E52529D4 
    ...
    $ echo "deb [ arch=amd64 ] https://repo.mongodb.org/apt/ubuntu bionic/mongodb-org/4.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-4.0.list 
    ...
    $ sudo apt-get update
    ...
    $ sudo apt-get install mongodb-org-shell mongodb-org-tools 
    ```

3. Перенесите дамп базы данных с вашего сервера на виртуальную машину, например, используя утилиту `scp`:

    ```
    scp ~/db_dump.tar.gz <имя пользователя ВМ>@<публичный адрес ВМ>:/tmp/db_dump.tar.gz
    ```

4. Распакуйте дамп на виртуальной машине:

    ```
    tar -xzf /tmp/db_dump.tar.gz
    ```

В результате вы должны получить виртуальную машину с дампом базы данных, который готов к восстановлению на кластер [!KEYREF mmg-name].


## Создать кластер [!KEYREF mmg-name] {#create-cluster}

Создайте кластер, вычислительная мощность и размер хранилища которого соответствуют среде, в которой развернута существующая база данных. Подробно о создании кластера [!KEYREF mmg-name] — на странице [[!TITLE]](cluster-create.md).
 

### Восстановление данных {#restore}

Восстанавливать базу данных из дампа следует с помощью утилиты [mongorestore](https://docs.mongodb.com/manual/reference/program/mongorestore/).

* Если вы восстанавливаете дамп с виртуальной машине в Облаке:

    ```
    $ mongorestore --host <адрес сервера СУБД> \
                   --port <порт> \
                   --username <имя пользователя> \
                   --password "<пароль>" \
                   -j <количество потоков> \
                   --authenticationDatabase <имя базы данных> \
                   --nsInclude '*.*' /tmp/db_dump
    ```

* Если вы восстанавливаете дамп с сервера вне Яндекс Облака для `mongorestore` необходимо явно задать параметры SSL: 

    ```
    $ mongorestore --host <адрес сервера СУБД> \
                   --port <порт> \
                   --ssl \
                   --sslCAFile <путь к файлу сертификата> \
                   --username <имя пользователя> \
                   --password "<пароль>" \
                   -j <количество потоков> \
                   --authenticationDatabase <имя базы данных> \
                   --nsInclude '*.*' /tmp/db_dump
    ```

* Если нужно перенести только определенные коллекции, то следует задать флаги `--nsInclude` и `--nsExclude`с указанием на пространства имен, которые нужно или не нужно включать для восстанавливаемого набора коллекций. 
