# Взаимосвязь ресурсов сервиса

Основными элементами сервиса являются [устройство](index.md#device) и [реестр](index.md#registry), которые могут обмениваться различными данными и командами.

Обмен данными происходит по протоколу [MQTT](https://mqtt.org) версии  3.1.1. Это упрощенный сетевой протокол для взаимодействия между устройствами по принципу издатель-подписчик. Также для взаимодействия реестров и устройств используются X.509 сертификаты. Управлять сертификатами можно с помощью [Yandex CLI](../../cli/quickstart.md) и API {{ iot-name }}.

## Устройство {#device}

_Устройство_ — экземпляр физического устройства, например, датчика температуры, представленный в сервисе в виде имени устройства и его сертификата.

 Устройство создается в реестре, может отправлять телеметрические данные, получать команды и взаимодействовать с другими устройствами в реестре.

## Реестр {#registry}

_Реестр_ — набор устройств, логически связанных между собой. Реестр может читать телеметрические данные устройств и отправлять им команды.

{% note info %}

Сертификат реестра можно разместить на виртуальной машине в Облаке, которую можно использовать для хранения и обработки поступающих данных.

{% endnote %}

## Взаимодействие устройств {#interactions}

Внутри сервиса устройства обмениваются данными и командами, представленными в виде сообщений c определенными топиками.

_Топик_ — тема сообщения, которая позволяет избирательно отправлять и получать данные.

В сервисе реализованы два типа топиков:

- Топики устройства: 

    - `$devices/<ID устройства>/events` — топик для отправки телеметрических данных.
    
        Устройство может писать в этот топик, а реестр — читать из него. Реестр, подписанный на данный топик, будет знать, какое именно устройство отправило данные, так как в топике присутствует уникальный идентификатор устройства.
    
    - `$devices/<ID устройства>/commands` — топик для получения команд.
    
        Реестр может писать в этот топик, а устройство — читать из него. В данный топик реестр отправляет команды, предназначенные конкретному устройству.

- Топики реестра: 

    - `$registries/<ID реестра>/events` — топик для получения телеметрических данных.
    
        Устройство может писать в этот топик, а реестр — читать из него. Реестр, подписанный на данный топик, не будет знать, какое именно устройство отправило данные, так как в топике отсутствует уникальный идентификатор устройства.
        
    - `$registries/<ID реестра>/commands` — топик для отправки команд.
    
        Реестр может писать в этот топик, а устройство — читать из него. В данный топик реестр отправляет команды, предназначенные всем устройствам в реестре.

{% note info %}

Топики реестра и устройства не связаны между собой.

{% endnote %}

Если устройство отправляет данные в топик устройства для телеметрических данных, получить их можно только подписавшись на этот топик. Аналогично для топика реестра.

В таблице описаны действия, которые устройства и реестры совершают с топиками:

Топик | Устройство | Реестр 
----|----|----
`$devices/<ID устройства>/events` | Отправляет телеметрические данные. | Получает телеметрические данные. <br/>Устройство известно.
`$devices/<ID устройства>/commands` | Получает команды. | Отправляет команды определенному устройству.
`$registries/<ID реестра>/events` | Отправляет телеметрические данные. | Получает телеметрические данные от всех устройств в реестре.<br/>Устройство неизвестно.
`$registries/<ID реестра>/commands` | Получает команды. | Отправляет команды всем устройствам в реестре. 

При обмене сообщениями можно использовать разные уровни качества обслуживания (QoS) для MQTT:

- `QoS 0: At most once`. Сообщение отправляется не более одного раза и без гарантии доставки.

- `QoS 1: At least once`. Сообщение гарантированно доставляется хотя бы один раз. Есть возможность получения дубликатов сообщения.

- `QoS 2: Exactly once`. Сообщение гарантированно доставляется один раз без дубликатов. **Не поддерживается на стадии [Preview](../../overview/concepts/launch-stages.md).**

