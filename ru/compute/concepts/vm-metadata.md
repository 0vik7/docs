# Сервис метаданных в виртуальных машинах Яндекс.Облака

Каждая виртуальная машина хранит сведения о себе в сервисе метаданных. Вы можете запрашивать эти метаданные изнутри виртуальной машины, с помощью API Яндекс.Облака или CLI.

Метаданные используются для выполнения настроек гостевыми агентами, например cloud-init. Это такие программы, которые используются для автоматической настройки виртуальных машин при запуске. Например, чтобы прописать имя хоста или указать открытый ключ SSH для подключения к виртуальной машине. Или задать список пользователей и данные для авторизации.

Изнутри виртуальной машины сервис метаданных доступен по IP-адресу `169.254.169.254`. Ваша виртуальная машина автоматически получает доступ к сервису метаданных без дополнительной авторизации.

## Формат метаданных при создании виртуальной машины

Метаданные указываются в виде пар `"ключ":"значение"` в поле metadata. Значение передаётся в виде строки. Если в значении указывается несколько строк, то они разделяются символом переноса строки `\n`.

При работе через CLI, в качестве значения можно указать путь к файлу. Например, таким образом удобно передавать пользовательские метаданные: `--metadata-from-file user-data=./my-userdata.yaml`.

Вы можете указывать любые ключи. То, какие ключи необходимо указывать зависит от того, какой гостевой агент будет их обрабатывать на вашей виртуальной машине.

> [!IMPORTANT]
> Метаданные, в том числе пользовательские, хранятся в незашифрованном виде. Каждый, кто имеет возможность подключиться к виртуальной машине, может получить эти данные. Если вы размещаете в метаданных конфиденциальную информацию, примите меры для ее защиты — например, зашифруйте ее самостоятельно.

В публичных образах Linux Яндекс.Облака по умолчанию используется [cloud-init](https://cloud-init.io). В публичных образах с Windows - [Cloudbase-init](https://cloudbase.it/cloudbase-init/).

Все пользовательские метаданные для гостевого агента cloud-init необходимо передать в ключе `user-data`. В `user-data` вы можете передать сценарий в формате cloud-config, который будет использован cloud-init. Формат cloud-config подробно описан в [документации cloud-init](https://cloudinit.readthedocs.io/en/latest/index.html).
В `user-data` можно передать несколько ключей SSH и указать, какой ключ для какого пользователя. Для этого передайте их в элементе  `users/ssh_authorized_keys`. Подробнее читайте в разделе [Users and Groups](https://cloudinit.readthedocs.io/en/latest/topics/modules.html#users-and-groups) в документации к cloud-init.

Например, ваш сценарий cloud-config может выглядеть так:

```
datasource:
  Ec2:
    strict_id: false
chpasswd:
  list: |
    root:secret
    test-user:usersecret
  expire: False
ssh_pwauth: no
users:
  - name: test-user
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh-authorized-keys:
      - ssh-rsa AAAAABBBB...ZZZZZ test-user@example.com
```

>[!NOTE]
>Помимо `user-data`, cloud-init еще обрабатывает ключи `ssh-keys` и `block-project-ssh-keys`. Но отдельной сущности для проектов в Яндекс.Облаке нет, поэтому `block-project-ssh-keys` работать не будет.
>В `ssh-keys` тоже можно передавать ключи SSH, но тогда cloud-init обработает только первый ключ SSH из списка. При этом ключ будет присвоен пользователю, который задан в конфигурации cloud-init по-умолчанию. В разных образах это разные пользователи.
>Если вы не знаете, какой пользователь задан по-умолчанию, рекомендуем передавать ключи SSH в `user-data`.

## Форматы метаданных изнутри виртуальной машины

На данный момент сервис метаданных Яндекс.Облака позволяет эмулировать метаданные в форматах Google Compute Engine и Amazon EC2.

### Google Compute Engine

Сервер метаданных Яндекс.Облака позволяет возвращать метаданные в формате Google Compute Engine.

#### Формат запроса

Адрес для запроса:

```
http://169.254.169.254/computeMetadata/v1/
```

В запросе необходимо указать заголовок

```
Metadata-Flavor: Google
```

PATH-параметры:

Параметр | Описание
----- | -----
`alt="<json|text>"` | Формат ответа (по умолчанию `text`).
`recursive="<true|false>"` | Если `true`, возвращает все значения по дереву рекурсивно. По умолчанию `false`.
`wait_for_change="<true|false>"` | Если `true`, ответ будет возвращен только когда один из параметров метаданных изменится. По умолчанию `false`.
`last_etag="text"` | Значение ETag из предыдущего ответа на аналогичный запрос. Используется в запросах для борьбы с рейсом. Используйте при `wait_for_change="true"`.
`timeout_sec="<int>"` | Максимальное время ожидания запроса. Используйте при `wait_for_change="true"`.

#### Примеры запросов

Чтобы узнать идентификатор виртуальной машины, выполните эту команду:

```
curl -H Metadata-Flavor:Google 169.254.169.254/computeMetadata/v1/id
```

Чтобы получить все элементы метаданных, воспользуйтесь опцией `recursive`:

```
curl -H Metadata-Flavor:Google 169.254.169.254/computeMetadata/v1/?recursive=true
```

Ключи выводятся без форматирования, поэтому чтобы получить их в человеко-читаемом виде, воспользуйтесь утилитой [jq](https://stedolan.github.io/jq/):

```
curl -H Metadata-Flavor:Google 169.254.169.254/computeMetadata/v1/?recursive=true | jq -r '.'
```

#### Список возвращаемых элементов

Список элементов, которые доступны по этому запросу.

Элемент | Описание
----- | -----
`attributes/` | Путь с пользовательскими метаданными, переданными при создании или изменении виртуальной машины в поле `metadata`.
`attributes/ssh-keys` | Список открытых SSH-ключей, переданных при создании виртуальной машины в поле `metadata` в значении ключа `ssh-keys`.
`description` | Текстовое описание, переданное при создании или изменении виртуальной машины.
`disks/` | Директория, в которой перечисляются диски, подключенные к виртуальной машине..
`hostname` | [FQDN](network.md#hostname), назначенный виртуальной машине.
`id` | ID виртуальной машины. Идентификатор генерируется автоматически при создании виртуальной машины и уникален в пределах всего Яндекс.Облака.
`name` | Имя, переданное при создании или изменении виртуальной машины.
`networkInterfaces/` | Директория, в которой перечисляются сетевые интерфейсы, подключенные к виртуальной машине.

Другие элементы, например `project` используются для обратной совместимости и остаются пустыми.


### Amazon EC2

Сервер метаданных Яндекс.Облака позволяет возвращать метаданные в формате Amazon EC2.

#### Формат запроса метаданных

Адрес для запроса:

```
http://169.254.169.254/latest/meta-data/<элемент>
```

Например, вы можете получить внутренний IP-адрес виртуальной машины, выполнив на ней следующую команду:

```
curl http://169.254.169.254/latest/meta-data/local-ipv4
```

#### Список возвращаемых элементов

> [!NOTE]
> В угловых скобках выделены параметры, которые необходимо заменить значениями. Например, вместо <mac> следует подставить MAC-адрес сетевого интерфейса.

Элемент | Описание
----- | -----
hostname | Имя хоста, присвоенное виртуальной машине.
instance-id | Идентификатор виртуальной машины.
local-ipv4 | Внутренний IPv4-адрес.
local-hostname | Имя хоста, присвоенное виртуальной машине.
mac | MAC-адрес сетевого интерфейса виртуальной машины.
network/interfaces/macs/<mac>/ipv6s | Внутренние IPv6-адреса, ассоциированные с сетевым интерфейсом.
network/interfaces/macs/<mac>/local-hostname | Имя хоста, ассоциированное с сетевым интерфейсом.
network/interfaces/macs/<mac>/local-ipv4s | Внутренние IPv4-адреса, ассоциированные с сетевым интерфейсом.
network/interfaces/macs/<mac>/mac | MAC-адрес сетевого интерфейса виртуальной машины.
public-ipv4 | Внешний IPv4-адрес.

#### Пользовательские метаданные

Пользовательские метаданные — произвольная строка размером до 16 КБ, переданная в поле `metadata` в значении ключа `user-data`. Пользовательские метаданные можно задать при создании виртуальной машины в API или в интерфейсе командной строки (CLI).

Адрес для запроса:

```
http://169.254.169.254/latest/user-data/
```
