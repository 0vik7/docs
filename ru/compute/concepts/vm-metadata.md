# Хранение и извлечение метаданных виртуальной машины

Каждая виртуальная машина хранит сведения о себе на сервере метаданных. Вы можете запрашивать эти метаданные изнутри виртуальной машины или [снаружи](../operations/vm-info/vm-info) с помощью API Яндекс.Облака или интерфейса командной строки (CLI).

Метаданные используют программы, которые запускаются при старте виртуальной машины. Например, чтобы задать список пользователей или указать открытый ключ SSH для подключения к виртуальной машине.

Изнутри виртуальной машины сервер метаданных доступен по IP-адресу `169.254.169.254`.

## Формат метаданных при создании виртуальной машины

Вы задаете метаданные в виде пар `"ключ":"значение"` в поле `metadata`. Значение передаётся в виде строки. Если в значении надо передать несколько строк, то они разделяются символом переноса строки `\n`.

При работе через CLI, значение еще можно передать в виде файла: `--metadata-from-file key=path/to/file`. Таким образом удобнее передать значение из нескольких строк.

Вы можете указывать любые ключи. То, какие ключи необходимо указывать зависит от того, какая программа будет их обрабатывать на вашей виртуальной машине. Например, в образах Linux, предоставляемых Яндекс.Облаком, используется `cloud-init`. Подробнее читайте в разделе [[!TITLE]](#public-images-metadata).

> [!IMPORTANT]
> Метаданные, в том числе пользовательские, хранятся в незашифрованном виде. Каждый, кто имеет возможность подключиться к виртуальной машине, может получить эти данные. Если вы размещаете в метаданных конфиденциальную информацию, примите меры для ее защиты — например, зашифруйте ее самостоятельно.

## Форматы метаданных изнутри виртуальной машины

На данный момент сервер метаданных Яндекс.Облака предоставляет метаданные в форматах Google Compute Engine и Amazon EC2.

### Google Compute Engine

Сервер метаданных Яндекс.Облака позволяет возвращать метаданные в формате Google Compute Engine.

#### Формат запроса

```
GET http://169.254.169.254/computeMetadata/v1/
  ?alt=<json|text>
  &recursive=<true|false>
  &wait_for_change=<true|false>
  &last_etag=<string>
  &timeout_sec=<int>
Metadata-Flavor: Google
```

**Query-параметры**

Параметр | Описание
----- | -----
`alt` | Формат ответа (по умолчанию `text`).
`recursive` | Если `true`, возвращает все значения по дереву рекурсивно. По умолчанию `false`.
`wait_for_change` | Если `true`, ответ будет возвращен только когда один из параметров метаданных изменится. По умолчанию `false`.
`last_etag` | Значение ETag из предыдущего ответа на аналогичный запрос. Используйте при `wait_for_change="true"`.
`timeout_sec` | Максимальное время ожидания запроса. Используйте при `wait_for_change="true"`.

#### Примеры запросов

Узнать идентификатор виртуальной машины изнутри машины:

```
curl -H Metadata-Flavor:Google 169.254.169.254/computeMetadata/v1/id
```

Чтобы получить все элементы метаданных, воспользуйтесь опцией `recursive`:

```
curl -H Metadata-Flavor:Google 169.254.169.254/computeMetadata/v1/?recursive=true
```

Метаданные выводятся в одну строку без форматирования. Чтобы получить их в удобном для чтения формате, воспользуйтесь утилитой [jq](https://stedolan.github.io/jq/):

```
curl -H Metadata-Flavor:Google 169.254.169.254/computeMetadata/v1/?recursive=true | jq -r '.'
```

#### Список возвращаемых элементов

Список элементов, которые доступны по этому запросу.

Элемент | Описание
----- | -----
`attributes/` | Путь с пользовательскими метаданными, переданными при создании или изменении виртуальной машины в поле `metadata`.
`attributes/ssh-keys` | Список открытых SSH-ключей, переданных при создании виртуальной машины в поле `metadata` в значении ключа `ssh-keys`.
`description` | Текстовое описание, переданное при создании или изменении виртуальной машины.
`disks/` | Директория, в которой перечисляются диски, подключенные к виртуальной машине..
`hostname` | [FQDN](network.md#hostname), назначенный виртуальной машине.
`id` | ID виртуальной машины. Идентификатор генерируется автоматически при создании виртуальной машины и уникален в пределах всего Яндекс.Облака.
`name` | Имя, переданное при создании или изменении виртуальной машины.
`networkInterfaces/` | Директория, в которой перечисляются сетевые интерфейсы, подключенные к виртуальной машине.

Другие элементы, например `project` используются для обратной совместимости и остаются пустыми.


### Amazon EC2

Сервер метаданных Яндекс.Облака позволяет возвращать метаданные в формате Amazon EC2.

#### Формат запроса метаданных

Адрес для запроса:

```
GET http://169.254.169.254/latest/meta-data/<элемент>
```

`<элемент>` — это путь к элементу, который вы хотите получить. Если не задан, в ответе вернется список доступных элементов.

#### Список возвращаемых элементов

> [!NOTE]
>
> В угловых скобках выделены параметры, которые необходимо заменить значениями. Например, вместо <mac> следует подставить MAC-адрес сетевого интерфейса.

Элемент | Описание
----- | -----
`hostname` | Имя хоста, присвоенное виртуальной машине.
`instance-id` | Идентификатор виртуальной машины.
`local-ipv4` | Внутренний IPv4-адрес.
`local-hostname` | Имя хоста, присвоенное виртуальной машине.
`mac` | MAC-адрес сетевого интерфейса виртуальной машины.
`network/interfaces/macs/<mac>/ipv6s` | Внутренние IPv6-адреса, ассоциированные с сетевым интерфейсом.
`network/interfaces/macs/<mac>/local-hostname` | Имя хоста, ассоциированное с сетевым интерфейсом.
`network/interfaces/macs/<mac>/local-ipv4s` | Внутренние IPv4-адреса, ассоциированные с сетевым интерфейсом.
`network/interfaces/macs/<mac>/mac` | MAC-адрес сетевого интерфейса виртуальной машины.
`public-ipv4` | Внешний IPv4-адрес.

#### Примеры запросов

Получить внутренний IP-адрес изнутри виртуальной машины:

```
curl http://169.254.169.254/latest/meta-data/local-ipv4
```


#### Пользовательские метаданные

Пользовательские метаданные — произвольная строка размером до 16 КБ, переданная в поле `metadata` в значении ключа `user-data`. Пользовательские метаданные можно задать при создании виртуальной машины в API или в интерфейсе командной строки (CLI).

Адрес для запроса:

```
http://169.254.169.254/latest/user-data/
```

## Программы, которые обрабатывают метаданные в публичных образах Яндекс.Облака {#public-images-metadata}

В публичных образах Linux Яндекс.Облака для настройки виртуальной машины по умолчанию используется [cloud-init](https://cloud-init.io). В публичных образах с Windows — [Cloudbase-Init](https://cloudbase.it/cloudbase-init/).

### Использование cloud-init

Cloud-init обрабатывает метаданные, которые были переданы в ключах `user-data` и `ssh-keys`.

#### user-data

Все пользовательские метаданные для `cloud-init` необходимо передать в ключе `user-data`. Есть [несколько форматов](https://cloudinit.readthedocs.io/en/latest/topics/format.html) метаданных, которые поддерживает cloud-init, например `cloud-config`.

Вы можете использовать `user-data`, чтобы передать ключи SSH на виртуальную машину и указать, какой ключ для какого пользователя. Для этого передайте их в элементе  `users/ssh_authorized_keys`. Подробнее читайте в разделе [Users and Groups](https://cloudinit.readthedocs.io/en/latest/topics/modules.html#users-and-groups) в документации к `cloud-init`.

Пример метаданных, которые вы можете задать в поле `user-data` в формате cloud-config:

```
#cloud-config
users:
  - name: demo
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh-authorized-keys:
      - ssh-rsa AAAAB3Nza......OjbSMRX user@example.com
      - ssh-rsa AAAAB3Nza......Pu00jRN user@desktop
```

#### ssh-keys

В `ssh-keys` тоже можно передавать ключи SSH, но тогда `cloud-init` обработает только первый ключ SSH из списка. При этом ключ будет присвоен пользователю, который задан в конфигурации `cloud-init` по-умолчанию. В разных образах это разные пользователи.

Если вы не знаете, какой пользователь задан по-умолчанию, рекомендуем передавать ключи SSH в `user-data`.
